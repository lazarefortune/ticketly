{% extends 'base.html.twig' %}

{% block title %}{{ event.name }}{% endblock %}

{% block body %}

    {% include 'partials/flash.html.twig' with {floating: true, duration: 3} %}

    <div class="container-box bg-white">
        <div class="mx-auto">
            <div class="stack mt-4">
                <p class="flex items-center gap-2 text-muted mx-auto">
                    {{ event.startDate|format_datetime('full', 'none', locale='fr') }}
                </p>
                <h1 class="text-2xl text-center uppercase font-bold">{{ event.name }}</h1>
                <p>{{ event.description }}</p>
                <div class="text-center">
                    <a href="#tickets" class="btn btn-primary mt-4">Acheter des billets</a>
                </div>
                <div class="mt-4 max-w-96 mx-auto">
                    <img src="{{ vich_uploader_asset(event, 'imageFile') }}" alt="{{ event.name }}-image" class="w-full mx-auto">
                </div>
            </div>

            <div class="mt-8">
                <h1 class="text-2xl font-bold">Heure et lieu</h1>
                <div class="stack mt-4">
                    <p class="text-muted flex items-center gap-2">
                        {{ icon('calendar') }}
                        <span>{{ event_duration(event.startDate, event.endDate) }}</span>
                    </p>
                    <p class="text-muted flex items-center gap-2">
                        {{ icon('map-pin') }}
                        <span>{{ event.location }}</span>
                    </p>
                </div>
            </div>

            <div class="mt-8" id="tickets">
                <h1 class="text-2xl font-bold">Billets</h1>
                <div class="stack my-4">
                    {% if event.isExpired %}
                        <div class="mt-4 text-center p-4 bg-red-100 rounded">
                            <p class="text-red-800">Les ventes pour cet événement sont terminées.</p>
                            <a href="" class="btn btn-primary mt-4">Voir les prochains événements</a>
                        </div>
                    {% else %}
                        {{ form_start(ticketForm) }}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-b border-slate-300 py-7">
                            <div class="stack">
                                <div>
                                    <p class="text-sm text-slate-500">Type de billet</p>
                                    <p class="mt-2 text-lg uppercase">{{ event.name }}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-slate-500">Fin de la vente</p>
                                    <p class="mt-2">{{ event.endSaleDate|format_datetime('medium', 'short', locale='fr') }}</p>
                                </div>
                            </div>
                            <div class="stack grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-slate-500">Prix</p>
                                    <p class="mt-2 text-lg">{{ event.price|price_format }}</p>
                                    <p class="text-slate-400">+0.80 € de frais de service</p>
                                </div>
                                <div class="flex flex-col">
                                    <p class="text-sm text-slate-500">Quantité</p>
                                    <div class="mt-2">
                                        {{ form_widget(ticketForm.quantity) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- total -->
                        <div class="mt-5 flex justify-between lg:max-w-80 lg:ml-auto">
                            <div id="totalBlock" class="w-full flex flex-col gap-2 mt-4">
                                <div id="subtotalBlock" class="justify-between text-xl items-center gap-2 hidden">
                                    <p class="text-sm lg:text-lg">Sous-total</p>
                                    <p class="text-sm lg:text-lg" id="subtotalPrice">0,00 €</p>
                                </div>
                                <div id="serviceFeeBlock" class="border-b border-slate-200 pb-2 justify-between text-xl items-center gap-2 hidden">
                                    <p class="text-sm lg:text-lg">Frais de service</p>
                                    <p class="text-sm lg:text-lg" id="serviceFee">0,00 €</p>
                                </div>
                                <div class="flex justify-between text-3xl items-center gap-2">
                                    <p class="text-xl">Total</p>
                                    <p class="text-xl" id="totalPrice">0,00 €</p>
                                </div>
                                <button type="submit" id="submitButton" class="btn-lg btn-primary mt-5" disabled>Passer la commande</button>
                            </div>
                        </div>
                        {{ form_end(ticketForm) }}
                    {% endif %}


                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const quantitySelect = document.getElementById('pre_book_event_quantity');
            const subtotalPriceElem = document.getElementById('subtotalPrice');
            const serviceFeeElem = document.getElementById('serviceFee');
            const totalPriceElem = document.getElementById('totalPrice');
            const submitButton = document.getElementById('submitButton');
            const subtotalBlock = document.getElementById('subtotalBlock');
            const serviceFeeBlock = document.getElementById('serviceFeeBlock');
            const ticketPrice = {{ event.price / 100 }};
            const serviceFee = 0.80;

            function updateTotals() {
                const quantity = parseInt(quantitySelect.value);
                const subtotalPrice = ticketPrice * quantity;
                const totalServiceFee = serviceFee * quantity;
                const totalPrice = subtotalPrice + totalServiceFee;

                subtotalPriceElem.textContent = subtotalPrice.toFixed(2) + ' €';
                serviceFeeElem.textContent = totalServiceFee.toFixed(2) + ' €';
                totalPriceElem.textContent = totalPrice.toFixed(2) + ' €';

                if (quantity > 0) {
                    subtotalBlock.classList.remove('hidden');
                    subtotalBlock.classList.add('flex');
                    serviceFeeBlock.classList.remove('hidden');
                    serviceFeeBlock.classList.add('flex');
                    submitButton.disabled = false;
                } else {
                    subtotalBlock.classList.add('hidden');
                    subtotalBlock.classList.remove('flex');
                    serviceFeeBlock.classList.add('hidden');
                    serviceFeeBlock.classList.remove('flex');
                    submitButton.disabled = true;
                }
            }

            // Call updateTotals on page load to ensure everything is up to date
            updateTotals();

            // Update totals whenever the quantity changes
            quantitySelect.addEventListener('change', updateTotals);
        });
    </script>

{% endblock %}
